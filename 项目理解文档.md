# AFAC Agent 项目理解文档

## 项目概述

这是一个参加2025年阿里云天池AFAC金融AI竞赛的智能Agent项目,旨在构建一个能够自动生成金融研报的AI系统。

**竞赛链接**: https://tianchi.aliyun.com/competition/entrance/532354

**项目版本**:
- **Version_0**: 基础版本,提供数据采集和基础分析功能
- **Version_1**: 增强版本,集成了搜索引擎、数据分析工具和图表质量检查功能

---

## 项目架构

### 整体流程

```
用户输入 → Agent调度 → 数据采集 → 数据分析 → 报告生成 → 输出
                ↓
          搜索引擎增强(V1)
          数据可视化(V1)
          质量检查(V1)
```

### 三大核心模块

1. **公司个股分析** (Part 1)
2. **行业分析** (Part 2)
3. **宏观经济分析** (Part 3)

---

## 代码结构详解

### Version_0 核心工具(基础数据采集)

#### 1. `get_company_intro.py` - 公司基本信息采集

**功能**: 从同花顺网站爬取公司基础信息

**主要函数**:
```python
get_company_profile_ths_cn(symbol)  # 获取A股公司信息
get_company_profile_ths_hk(symbol)  # 获取港股公司信息
get_cn_company_profile_ak(symbol)   # 使用akshare获取A股信息
get_hk_company_profile_ak(symbol)   # 使用akshare获取港股信息
```

**返回数据**:
- 公司名称(中英文)
- 主营业务
- 所属行业
- 公司简介

**技术实现**:
- 使用BeautifulSoup解析HTML
- 支持中国A股和香港股市
- 包含错误处理机制


#### 2. `get_financial_data_annual.py` - 财务数据下载

**功能**: 下载公司年度财务报表

**支持的财务报表类型**:
- `main`: 主要指标
- `debt`: 资产负债表
- `benift`: 利润表
- `cash`: 现金流量表

**主要函数**:
```python
download_hk_financial_data(symbol, type='main')  # 港股财务数据
download_cn_financial_data(symbol, type='main')  # A股财务数据
```

**文件输出**: Excel格式(.xls)


#### 3. `get_stock_info.py` - 股票行情数据

**功能**: 获取股票历史交易数据

**主要函数**:
```python
get_cn_stock_info(symbol, period="monthly", start_date, end_date)
get_hk_stock_info(symbol, period="monthly", start_date, end_date)
```

**返回数据字段**:
- 日期、开盘价、收盘价、最高价、最低价
- 成交量、成交额
- 振幅、涨跌幅、涨跌额、换手率


#### 4. `get_rating_info.py` - 机构评级信息

**功能**: 获取证券机构对公司的评级和预测

**主要函数**:
```python
get_hk_rating_info(symbol)  # 港股评级
get_cn_rating_info(symbol)  # A股评级(业绩预测详表)
```

**数据来源**:
- 同花顺网站(港股)
- akshare库(A股)


#### 5. `get_capital_structure.py` - 股本结构

**功能**: 获取公司股本变动历史

**主要函数**:
```python
get_capital_structure_cn_ths(symbol)  # A股股本结构
get_capital_structure_hk_ths(symbol)  # 港股股本结构
```

**返回数据**: 包含总股本、流通股本等各期数据的DataFrame


#### 6. `get_cn_control.py` - 主力控盘数据

**功能**: 获取A股主力资金控盘情况(仅限A股)

**主要函数**:
```python
get_cn_control(symbol)
```


#### 7. `get_company_field_compare.py` - 同行业对比

**功能**: 对比同行业公司的财务指标

**主要函数**:
```python
get_hk_company_field_compare(symbol)  # 港股行业对比
get_cn_company_field_compare(symbol)  # A股行业对比
```

**返回数据**: 包含价值表现、财务指标等多期对比数据的列表


#### 8. `get_company_finance_summary.py` - 财务摘要

**功能**: 获取公司财务状况文字摘要

**主要函数**:
```python
get_company_finance_summary_hk(symbol)  # 港股(返回2024年摘要)
get_company_finance_summary_cn(symbol)  # A股(返回近3期摘要)
```


#### 9. `get_worth_predict.py` - 估值预测

**功能**: 获取机构对公司未来业绩的预测

**主要函数**:
```python
get_cn_worth_predict(symbol)  # A股估值预测
get_hk_worth_predict(symbol)  # 港股盈利预测
```

---

### Version_1 增强功能

#### 1. `constants.py` - 配置与模型管理

**API密钥配置**:
```python
E2B_API_KEY      # E2B沙箱环境密钥
ALI_API_KEY      # 阿里云API密钥
BAIDU_KEY        # 百度搜索API密钥
```

**LLM模型配置**:
- `deepseek-v3`: 主力推理模型
- `deepseek-r1`: 增强推理模型
- `qwen-plus-latest`: 通用任务模型
- `qwen-flash`: 快速响应模型
- `qwen-vl-plus-latest`: 视觉语言模型

**核心工具函数**:
```python
get_text_embedding(text)  # 获取文本向量(1024维)
```


#### 2. `financial_data_search.py` - 搜索引擎增强

这是V1版本的核心模块,实现了智能搜索和多步推理功能。

##### 核心搜索功能

**百度搜索**:
```python
baidu_search(query, top_k=20)
```
- 调用百度千帆AI Search API
- 支持半年内最新信息检索
- 返回标题、内容、URL

**arXiv学术搜索**:
```python
arxiv_search(query, top_k=20)
```
- 搜索学术论文
- 下载并解析PDF
- 提取摘要、引言、相关工作、结论等章节

##### 智能问答流程

**简单问答**:
```python
async simple_qa_en_baidu(query, max_search_num=10)
```

执行步骤:
1. 问题改写优化
2. 百度搜索获取资料
3. 向量相似度排序(Top-K)
4. 选择最相关网页深度阅读
5. DFS递归点击链接获取详细信息
6. LLM整合回答

**金融领域专用问答**:
```python
async simple_qa_en_baidu_financial(query, max_search_num=10)
```
- 针对金融场景优化
- 支持财报、研报等专业资料解析


**学术问答**:
```python
simple_qa_en_arxiv(query, max_search_num=10)
```
- 下载最相关论文PDF
- 使用pdf4llm转为Markdown
- 提取关键章节回答


##### 多步推理系统

**通用多步问答**:
```python
async multi_step_qa_en(question)
```

执行流程:
```
原始问题 → 任务改写 → 子任务拆分 → 路由判断 → 分别回答 → 汇总答案
                                    ↓
                            knowledge / search / arxiv
```

**金融专用多步问答**:
```python
async financial_search(question)
```
- 使用金融领域提示词模板
- 优化子任务拆分策略


##### 网页内容提取

**智能网页抓取**:
```python
async get_content_from_url(url, referer=None, if_text_only=True)
```

支持格式:
- HTML网页 (使用Crawl4AI)
- PDF文档 (使用pdf4llm)
- Excel文件 (pandas读取)
- CSV文件
- TXT文本文件

**深度搜索DFS**:
```python
async dfs_click_url(user_query, current_url, refer_url,
                    current_depth, max_depth, visited_urls)
```
- 自动点击相关链接
- 最多2层深度
- 避免重复访问


#### 3. `get_dfcf_research_info.py` - 东方财富研报采集

这个模块专门从东方财富网获取各类研究报告。

##### 行业研报

**获取研报列表**:
```python
get_dfcf_industry_research_report_list(
    industry_code,   # 行业代码
    max_page=1,      # 最大页数
    years_ago=2,     # 获取最近几年
    save_path=None   # CSV保存路径
)
```

**获取研报内容**:
```python
get_dfcf_industry_resport_content(dfcf_research_df, industry_code)
```
- 自动解析HTML内容
- 提取PDF下载链接
- 保存为CSV格式


##### 个股研报

```python
get_dfcf_company_research_report_list(industry_code, max_page=1, years_ago=2)
get_dfcf_company_resport_content(dfcf_research_df, industry_code)
```

**注意**: 无法直接通过股票代码搜索,需要先知道所属行业代码


##### 宏观研究

```python
get_dfcf_macro_research_report_list(max_page=1, years_ago=2)
get_dfcf_macro_resport_content(dfcf_research_df)
```


##### 晨报

```python
get_dfcf_chenbao_research_report_list(max_page=1, years_ago=2)
get_dfcf_chenbao_resport_content(dfcf_research_df)
```

**行业代码映射**:
项目内置了完整的行业代码字典(`industry_dict`),包含100+个行业分类。


#### 4. `python_data_analyse.py` - 数据分析与可视化

这是V1版本的数据分析核心模块,集成了E2B沙箱和VLM质量检查。

##### E2B沙箱执行

**代码执行函数**:
```python
code_interpret(e2b_code_interpreter, code)
```
- 在隔离环境中运行Python代码
- 捕获标准输出和错误
- 返回执行结果


**数据分析流程**:
```python
run_data_analysis(task, local_save_path, remote_save_path)
```

执行步骤:
1. 使用LLM生成数据分析代码
2. 语法检查(避免错误代码)
3. E2B沙箱执行
4. 结果下载到本地
5. 如果失败,自动重试并修复


##### 图表生成

**HTML表格生成**:
```python
# 提示词模板
html_table_gen_template
```
- 生成完整的HTML文件
- 包含现代化CSS样式
- 支持响应式布局
- 纯白背景便于截图


**HTML图表生成**:
```python
# 提示词模板
html_pic_gen_template
```
- 使用Chart.js绘制图表
- 支持柱状图、折线图、饼图等
- 800x400固定尺寸
- 纯白背景


##### VLM质量检查

**图表质量检测**:
```python
vlm_check_function(image_path, task)
```

检查维度:
- 清晰度和锐度
- 字体大小和可读性
- 数据标签准确性
- 图表类型适配性
- 颜色使用合理性
- 布局美观性

**返回格式**:
```json
{
  "result": "PASS" / "FAIL",
  "reason": "原因说明",
  "suggestions": "改进建议"
}
```

**自动优化流程**:
```python
chat_with_llm_after_vlm_check(
    e2b_code_interpreter,
    user_message,
    pre_code,
    vlm_feedback
)
```
- VLM检测失败后自动重新生成
- 根据反馈优化代码
- 最多重试2次


##### 截图功能

**Playwright截图**:
```python
async screenshot_with_playwright_async(html_file, selector, output_png)
```

智能选择器逻辑:
1. 优先尝试截取`<canvas>`元素
2. 如果没有canvas,使用用户指定选择器
3. 自动裁剪到元素边界
4. 支持高DPI(Retina)输出


---

## 主要工作流 Pipeline

### Part 1: 公司个股分析

**文件**: `part1_company_full_pipeline_release.ipynb`

**分析内容**:
1. 公司基本信息
2. 财务数据(资产负债表、利润表、现金流量表)
3. 股价走势分析
4. 机构评级汇总
5. 行业对比分析
6. 估值预测

**输出**: PDF格式的个股研报


### Part 2: 行业分析

**文件**: `part2_industry_full_pipeline_release.ipynb`

**分析内容**:
1. 行业概况
2. 行业内主要公司对比
3. 行业财务指标分析
4. 行业研报汇总
5. 行业发展趋势

**输出**: PDF格式的行业研报


### Part 3: 宏观经济分析

**文件**: `part3_macro_full_pipeline_release.ipynb`

**分析内容**:
1. 宏观经济指标
2. 政策分析
3. 市场环境
4. 宏观研报汇总
5. 经济走势判断

**输出**: PDF格式的宏观研报


---

## 技术栈总结

### 数据采集
- **akshare**: 金融数据接口库
- **requests + BeautifulSoup**: 网页爬虫
- **pandas**: 数据处理

### V1增强技术栈

#### LLM框架
- **langchain**: LLM应用开发框架
- **langchain_openai**: OpenAI兼容接口
- **langchain_community**: 社区模型集成

#### 搜索与爬虫
- **百度千帆AI Search**: 实时网络搜索
- **arxiv**: 学术论文检索
- **crawl4ai**: 智能网页爬取
- **playwright**: 浏览器自动化
- **pdf4llm**: PDF转Markdown

#### 数据分析
- **E2B Sandbox**: 云端Python沙箱环境
- **numpy + pandas**: 数据科学计算
- **matplotlib**: 数据可视化

#### VLM与向量
- **阿里云通义千问VL**: 视觉语言模型
- **multimodal-embedding-v1**: 多模态向量模型
- **rank_bm25**: BM25文本检索算法

#### 其他工具
- **jieba**: 中文分词
- **selenium/webdriver**: 浏览器驱动(V0遗留)
- **Chart.js**: JavaScript图表库


---

## 使用指南

### 环境安装

```bash
pip install numpy pandas matplotlib langchain_openai \
    langchain_community langchain_core requests akshare \
    chineseize-matplotlib
```

### 基础使用(Version_0)

```python
# 1. 获取公司基本信息
from get_company_intro import get_company_profile_ths_cn

company_info = get_company_profile_ths_cn("000066")
print(company_info)

# 2. 下载财务数据
from get_financial_data_annual import download_cn_financial_data

filename = download_cn_financial_data("000066", type="main")

# 3. 获取股票行情
from get_stock_info import get_cn_stock_info

stock_data = get_cn_stock_info(
    "000066",
    period="daily",
    start_date="20240101",
    end_date="20240601"
)
```

### 高级使用(Version_1)

**1. 配置API密钥**:

编辑`v1_version/constants.py`:
```python
E2B_API_KEY = 'your_e2b_key'
ALI_API_KEY = 'your_ali_key'
BAIDU_KEY = 'your_baidu_key'
```

**2. 使用搜索功能**:

```python
from financial_data_search import simple_qa_en_baidu
import asyncio

async def main():
    answer = await simple_qa_en_baidu(
        "美团和饿了么今年市场份额对比",
        max_search_num=10
    )
    print(answer)

asyncio.run(main())
```

**3. 多步推理**:

```python
from financial_data_search import financial_search
import asyncio

async def main():
    answer = await financial_search(
        "请分析比亚迪2024年的竞争优势和面临的挑战"
    )
    print(answer)

asyncio.run(main())
```

**4. 数据分析**:

```python
from python_data_analyse import run_data_analysis

task = """
请分析以下数据并计算平均值:
数据 = [10, 20, 30, 40, 50]

同时绘制柱状图展示这些数据,并将图片保存为result.png
"""

run_data_analysis(
    task=task,
    local_save_path="./result.png",
    remote_save_path="/home/user/result.png"
)
```


---

## 关键特性

### Version_0 特性
- 覆盖A股和港股
- 支持多种财务数据下载
- 自动化数据采集
- 包含错误处理机制

### Version_1 新增特性

1. **搜索引擎集成**
   - 百度实时搜索
   - arXiv学术搜索
   - 智能网页内容提取

2. **数据分析工具**
   - E2B沙箱安全执行代码
   - 自动生成数据分析代码
   - 支持图表可视化

3. **图表质量检查**
   - VLM自动评估图表质量
   - 根据反馈自动优化
   - 确保输出符合标准

4. **多步推理能力**
   - 自动拆分复杂问题
   - 智能路由(知识/搜索/学术)
   - 整合多源信息


---

## 项目亮点

1. **全面的数据覆盖**: 整合了公司基本面、财务数据、市场表现、机构观点等多维度信息

2. **双市场支持**: 同时支持中国A股和香港股市的数据采集

3. **模块化设计**: 每个功能独立封装,便于维护和扩展

4. **错误处理**: 包含完善的异常处理机制,提高稳定性

5. **V1智能增强**:
   - 实时信息获取能力
   - 自动化数据分析
   - 质量检查闭环
   - 多模态AI集成

6. **专业化场景**: 针对金融领域深度优化提示词和流程


---

## 注意事项

### 数据源限制

1. **访问频率**: 同花顺等网站有反爬虫机制,建议在循环中加入适当延时(`sleep(20)`)

2. **数据时效性**: 部分数据可能存在延迟,建议结合多个数据源验证

3. **股票代码格式**:
   - A股: 6位数字(如"000066")
   - 港股: 4位数字(如"0020")

### API配额

- **E2B沙箱**: 免费版有使用限制
- **百度千帆**: 需要付费API密钥
- **阿里云模型**: 有调用额度限制

### 性能优化建议

1. 使用向量检索优化搜索结果排序
2. 缓存常用数据避免重复请求
3. 异步并发提高爬取效率
4. 合理设置超时和重试机制


---

## 参考资料

- **知乎文章**:
  - 数据采集: https://zhuanlan.zhihu.com/p/1932786778286297319
  - Agent设计: https://zhuanlan.zhihu.com/p/1932787728283592116

- **官方文档**:
  - akshare: https://akshare.akfamily.xyz/
  - E2B: https://e2b.dev/docs
  - Crawl4AI: https://docs.crawl4ai.com/

- **竞赛页面**: https://tianchi.aliyun.com/competition/entrance/532354


---

## 总结

这是一个功能完善的金融AI Agent系统,Version_0提供了坚实的数据基础,Version_1则通过搜索引擎、数据分析工具和VLM质量检查实现了智能化升级,能够自动完成从数据采集到报告生成的全流程工作。

项目的模块化设计使其易于扩展,可以根据需要添加新的数据源或分析方法。同时,完善的错误处理和质量检查机制保证了系统的稳定性和输出质量。
